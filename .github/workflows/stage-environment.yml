name: 🚀 Stage Environment - Integration Tests & Deploy

on:
  push:
    branches: [ stage ]
  workflow_dispatch:

env:
  JAVA_VERSION: '11'
  MAVEN_OPTS: -Xmx2048m
  MINIKUBE_CPUS: '6'
  MINIKUBE_MEMORY: '16384'

jobs:
  build-and-integration-tests:
    name: 🏗️ Build & Integration Tests
    runs-on: self-hosted
    
    strategy:
      matrix:
        service: 
          - user-service
          - product-service
          - order-service
          - payment-service
          - shipping-service
          - favourite-service
      fail-fast: false
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3
      
      - name: ☕ Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: 🔨 Build ${{ matrix.service }}
        working-directory: ./${{ matrix.service }}
        run: ./mvnw.cmd clean compile -DskipTests
        shell: powershell
      
      - name: 🧪 Run Unit Tests
        working-directory: ./${{ matrix.service }}
        run: ./mvnw.cmd test -Dtest="*Test" -DfailIfNoTests=false
        shell: powershell
      
      - name: 🔗 Run Integration Tests
        working-directory: ./${{ matrix.service }}
        run: |
          Write-Host "🔗 Ejecutando tests de integración para ${{ matrix.service }}..." -ForegroundColor Cyan
          ./mvnw.cmd verify -Dtest="*IT,*IntegrationTest" -DfailIfNoTests=false
          if ($LASTEXITCODE -ne 0) {
            Write-Host "⚠️ Algunos tests de integración fallaron" -ForegroundColor Yellow
          } else {
            Write-Host "✅ Tests de integración exitosos" -ForegroundColor Green
          }
        shell: powershell
        continue-on-error: true
      
      - name: 📊 Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always()
        with:
          files: |
            ${{ matrix.service }}/target/surefire-reports/*.xml
            ${{ matrix.service }}/target/failsafe-reports/*.xml
          check_name: "Integration Tests - ${{ matrix.service }}"
      
      - name: 📦 Package ${{ matrix.service }}
        working-directory: ./${{ matrix.service }}
        run: ./mvnw.cmd package -DskipTests
        shell: powershell
      
      - name: 🐳 Build Docker Image
        working-directory: ./${{ matrix.service }}
        run: |
          docker build -t ${{ matrix.service }}:stage .
          Write-Host "✅ Imagen Docker creada: ${{ matrix.service }}:stage" -ForegroundColor Green
        shell: powershell
      
      - name: 📤 Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-stage
          path: ${{ matrix.service }}/target/*.jar
          retention-days: 14

  deploy-to-minikube:
    name: 🚢 Deploy to Minikube (Stage)
    runs-on: self-hosted
    needs: build-and-integration-tests
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3
      
      - name: 🔍 Check Minikube Status
        run: |
          $status = minikube status --format='{{.Host}}'
          if ($status -ne "Running") {
            Write-Host "🚀 Iniciando Minikube..." -ForegroundColor Yellow
            minikube start --driver=docker --cpus=${{ env.MINIKUBE_CPUS }} --memory=${{ env.MINIKUBE_MEMORY }}
          } else {
            Write-Host "✅ Minikube ya está corriendo" -ForegroundColor Green
          }
        shell: powershell
      
      - name: 📦 Load Docker Images to Minikube
        run: |
          $services = @('user-service', 'product-service', 'order-service', 'payment-service', 'shipping-service', 'favourite-service')
          foreach ($service in $services) {
            Write-Host "📦 Cargando $service`:stage a Minikube..." -ForegroundColor Cyan
            minikube image load "$service`:stage"
          }
        shell: powershell
      
      - name: 🚀 Deploy to Kubernetes
        run: |
          Write-Host "🚀 Desplegando servicios de soporte..." -ForegroundColor Cyan
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/zipkin-deployment.yaml
          kubectl apply -f k8s/cloud-config-deployment.yaml
          kubectl apply -f k8s/service-discovery-deployment.yaml
          kubectl apply -f k8s/api-gateway-deployment.yaml
          
          Start-Sleep -Seconds 30
          
          Write-Host "🚀 Desplegando microservicios..." -ForegroundColor Cyan
          kubectl apply -f k8s/user-service-deployment.yaml
          kubectl apply -f k8s/product-service-deployment.yaml
          kubectl apply -f k8s/order-service-deployment.yaml
          kubectl apply -f k8s/payment-service-deployment.yaml
          kubectl apply -f k8s/shipping-service-deployment.yaml
          kubectl apply -f k8s/favourite-service-deployment.yaml
        shell: powershell
      
      - name: ⏳ Wait for Deployments
        run: |
          Write-Host "⏳ Esperando a que los pods estén listos..." -ForegroundColor Yellow
          kubectl wait --for=condition=ready pod -l app=user-service -n ecommerce-microservices --timeout=300s
          kubectl wait --for=condition=ready pod -l app=product-service -n ecommerce-microservices --timeout=300s
          kubectl wait --for=condition=ready pod -l app=order-service -n ecommerce-microservices --timeout=300s
        shell: powershell
        continue-on-error: true
      
      - name: 🏥 Health Checks
        run: |
          Write-Host "🏥 Verificando salud de los servicios..." -ForegroundColor Cyan
          $services = @('user-service', 'product-service', 'order-service', 'payment-service', 'shipping-service', 'favourite-service')
          
          foreach ($service in $services) {
            $pods = kubectl get pods -n ecommerce-microservices -l app=$service -o jsonpath='{.items[*].status.phase}'
            Write-Host "📊 $service`: $pods" -ForegroundColor $(if ($pods -eq "Running") { "Green" } else { "Yellow" })
          }
        shell: powershell
      
      - name: 📋 Deployment Summary
        run: |
          Write-Host "╔════════════════════════════════════════════════════╗" -ForegroundColor Cyan
          Write-Host "║     🚀 STAGE DEPLOYMENT COMPLETED                ║" -ForegroundColor Cyan
          Write-Host "╚════════════════════════════════════════════════════╝" -ForegroundColor Cyan
          Write-Host ""
          kubectl get pods -n ecommerce-microservices
          Write-Host ""
          Write-Host "✅ Servicios desplegados en Minikube (Stage)" -ForegroundColor Green
          Write-Host "🧪 Tests de integración ejecutados" -ForegroundColor Green
          Write-Host ""
          Write-Host "🎯 Listo para Production Deployment" -ForegroundColor Yellow
        shell: powershell


